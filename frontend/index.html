<!DOCTYPE html>
<html>
<head>
    <title>Trail Running Visualization</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script>
    <style>
        /* Layout: navbar + map filling rest of viewport */
        html, body {
            height: 100%;
            margin: 0;
        }
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        .navbar {
            height: 56px;
            background: #2c3e50;
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .navbar .title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .navbar .actions {
            margin-left: auto;
        }
        .navbar button {
            background: #3498db;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .navbar button:hover { background: #2980b9; }

        #map {
            flex: 1; /* fills remaining viewport space */
            min-height: 0; /* avoids overflow in some browsers */
        }

        /* small adjustments for GPX popups/icons if needed */
        .gpx-info { font-size: 0.9rem; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="title">Trail Run — Live Visualization</div>
        <div class="actions">
            <button id="zoom-fit" title="Fit map to route">Fit Route</button>
        </div>
    </nav>

    <div id="map"></div>

    <script>
        // Create the Leaflet map
        const map = L.map('map').setView([0, 0], 13); // Initial view (will be updated)

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Load the GPX file and center the map
        const gpxFile = './ADN_Race2025.gpx'; // O GPX deve estar acessível via HTTP no servidor do frontend
        const gpxLayer = new L.GPX(gpxFile, {
            async: true, // Carrega o ficheiro GPX de forma assíncrona
            marker_options: {
                startIconUrl: "./start.png",
                endIconUrl: "./finish.png",
            }
        }).on('loaded', function(e) {
            // Ajusta o mapa aos limites da rota GPX
            map.fitBounds(e.target.getBounds());
        }).addTo(map);

        // Fit button: re-center to GPX bounds if available
        document.getElementById('zoom-fit').addEventListener('click', () => {
            try {
                const bounds = gpxLayer.getBounds && gpxLayer.getBounds();
                if (bounds && bounds.isValid && bounds.isValid()) {
                    map.fitBounds(bounds);
                } else if (bounds) {
                    map.fitBounds(bounds);
                } else {
                    console.warn('GPX bounds not available yet.');
                }
            } catch (err) {
                console.error('Unable to fit map to route:', err);
            }
        });

        // Dictionary to store markers for each athlete
        const athleteMarkers = {};

        const maleIcon = L.icon({
            iconUrl: "male.png",
            iconSize: [28, 65],
            iconAnchor: [12, 64],
            popupAnchor: [-3, -46]
        });

        const femaleIcon = L.icon({
            iconUrl: "female.png",
            iconSize: [28, 65],
            iconAnchor: [12, 64],
            popupAnchor: [-3, -46]
        });

        // Função para ligar ao WebSocket com reconexão automática
        function connectWebSocket() {
            // Cria a ligação WebSocket usando o hostname atual
            const socket = new WebSocket("ws://" + window.location.hostname + ":8000/ws");

            // Evento ao receber mensagem do backend
            socket.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);

                    // Validação dos dados recebidos
                    if (!data.athlete || !data.location || !data.location.latitude || !data.location.longitude || !data.gender) {
                        console.warn("Mensagem WebSocket ignorada: formato inválido", data);
                        return;
                    }

                    // Extrai dados do atleta
                    const athlete = data.athlete;
                    const gender = data.gender;
                    const lat = data.location.latitude;
                    const lon = data.location.longitude;

                    // Escolhe o ícone com base no género
                    const icon = gender === "male" ? maleIcon : femaleIcon;

                    // Atualiza o marcador se já existir, senão cria um novo
                    if (athlete in athleteMarkers) {
                        athleteMarkers[athlete].setLatLng([lat, lon]);
                    } else {
                        // Cria novo marcador para o atleta
                        const marker = L.marker([lat, lon], {icon: icon})
                            .addTo(map)
                            .bindPopup(`<b>${athlete}</b>`);
                        athleteMarkers[athlete] = marker;
                    }
                } catch (e) {
                    // Erro ao processar mensagem recebida
                    console.error("Erro ao processar mensagem WebSocket:", e);
                }
            };

            // Evento ao perder ligação WebSocket
            socket.onclose = function () {
                console.warn("Ligação WebSocket perdida. A tentar reconectar...");
                setTimeout(connectWebSocket, 2000);
            };

            // Evento de erro na ligação WebSocket
            socket.onerror = function (e) {
                console.error("Erro na ligação WebSocket:", e);
                socket.close();
            };
        }
        // Inicia a ligação WebSocket
        connectWebSocket();
    </script>
</body>
</html>