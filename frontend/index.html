<!DOCTYPE html>
<html>
<head>
    <title>Trail Running Visualization</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script>
    <style>
        #map {
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Create the Leaflet map
        const map = L.map('map').setView([0, 0], 13); // Initial view (will be updated)

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Load the GPX file and center the map
        const gpxFile = '/gpx/trail_route.gpx'; // O GPX deve estar acessível via HTTP no servidor do frontend
        const gpxLayer = new L.GPX(gpxFile, {
            async: true, // Carrega o ficheiro GPX de forma assíncrona
            marker_options: {
                startIconUrl: "./start.png",
                endIconUrl: "./finish.png",
            }
        }).on('loaded', function(e) {
            // Ajusta o mapa aos limites da rota GPX
            map.fitBounds(e.target.getBounds());
        }).addTo(map);

        // Dictionary to store markers for each athlete
        const athleteMarkers = {};

        const maleIcon = L.icon({
            iconUrl: "male.png", //"https://leafletjs.com/examples/custom-icons/leaf-blue.png", // Replace with a blue icon
          //  shadowUrl: "https://leafletjs.com/examples/custom-icons/leaf-shadow.png",
            iconSize: [28, 65],
          //  shadowSize: [50, 64],
            iconAnchor: [12, 64],
          //  shadowAnchor: [4, 62],
            popupAnchor: [-3, -46]
        });

        const femaleIcon = L.icon({
            iconUrl: "female.png", //"https://leafletjs.com/examples/custom-icons/leaf-pink.png", // Replace with a pink icon
         //   shadowUrl: "https://leafletjs.com/examples/custom-icons/leaf-shadow.png",
            iconSize: [28, 65],
           // shadowSize: [50, 64],
            iconAnchor: [12, 64],
           // shadowAnchor: [4, 62],
            popupAnchor: [-3, -46]
        });

        // Função para ligar ao WebSocket com reconexão automática
        function connectWebSocket() {
            // Cria a ligação WebSocket usando o hostname atual
            const socket = new WebSocket("ws://" + window.location.hostname + ":8000/ws");

            // Evento ao receber mensagem do backend
            socket.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);

                    // Validação dos dados recebidos
                    if (!data.athlete || !data.location || !data.location.latitude || !data.location.longitude || !data.gender) {
                        console.warn("Mensagem WebSocket ignorada: formato inválido", data);
                        return;
                    }

                    // Extrai dados do atleta
                    const athlete = data.athlete;
                    const gender = data.gender;
                    const lat = data.location.latitude;
                    const lon = data.location.longitude;

                    // Escolhe o ícone com base no género
                    const icon = gender === "male" ? maleIcon : femaleIcon;

                    // Atualiza o marcador se já existir, senão cria um novo
                    if (athlete in athleteMarkers) {
                        athleteMarkers[athlete].setLatLng([lat, lon]);
                    } else {
                        // Cria novo marcador para o atleta
                        const marker = L.marker([lat, lon], {icon: icon})
                            .addTo(map)
                            .bindPopup(`<b>${athlete}</b>`);
                        athleteMarkers[athlete] = marker;
                    }
                } catch (e) {
                    // Erro ao processar mensagem recebida
                    console.error("Erro ao processar mensagem WebSocket:", e);
                }
            };

            // Evento ao perder ligação WebSocket
            socket.onclose = function () {
                console.warn("Ligação WebSocket perdida. A tentar reconectar...");
                setTimeout(connectWebSocket, 2000);
            };

            // Evento de erro na ligação WebSocket
            socket.onerror = function (e) {
                console.error("Erro na ligação WebSocket:", e);
                socket.close();
            };
        }
        // Inicia a ligação WebSocket
        connectWebSocket();
    </script>
</body>
</html>